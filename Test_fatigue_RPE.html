<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test de Fatigue RCF</title>

  <!-- Librairie pour export Excel (.xlsx) - garde au cas o√π -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2f7ccc">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #e3f1ff; /* fond bleu clair RCF */
      font-size: 18px;      /* + lisible sur tablette */
    }

    /* ---------- TOP BAR ---------- */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .logo-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      flex: 0 0 auto;
    }

    .logo-rcf {
      max-width: 60px;
      height: auto;
    }

    .top-title {
      flex: 1 1 auto;
      text-align: center;
    }

    h1 {
      margin: 0;
      color: #2f7ccc;
      font-size: 26px;
    }
    h2 {
      margin: 0;
      font-size: 16px;
      color: #4a6580;
    }

    /* Bouton Mode Coach : rond, discret, l√©ger effet 3D */
    .mode-toggle-btn {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(145deg, #3f82cf, #1f5ba8);
      color: #fff;
      box-shadow: 0 3px 6px rgba(0,0,0,0.25);
      opacity: 0.85;
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        opacity 0.2s ease,
        background 0.2s ease;
      white-space: nowrap;
    }

    .mode-toggle-btn:hover {
      opacity: 1;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }

    .mode-toggle-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Couleur diff√©rente quand le mode coach est actif */
    .mode-toggle-btn.coach-on {
      background: linear-gradient(145deg, #12b886, #0f8f66);
    }

    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 2px solid #6bb4ff;
      flex: 2 1 540px;
      min-width: 0;
    }
    .stats-card {
      background: #fff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 2px solid #6bb4ff;
      flex: 1 1 260px;
      min-width: 0;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      align-items: center;
    }
    .row label {
      font-weight: bold;
      flex: 1 0 140px;
      font-size: 16px;
    }

    .row input[type="text"],
    .row input[type="date"],
    .row select,
    .row textarea {
      flex: 2 1 200px;
      padding: 12px;
      font-size: 18px;
      border-radius: 10px;
      border: 1px solid #ccc;
      min-height: 46px;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .question {
      margin-bottom: 22px;
    }
    .question > label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    .scale {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      margin-top: 8px;
    }
    .scale button {
      flex: 1 0 18%;
      padding: 16px 0;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 22px;
      cursor: pointer;
      background: #f5f5f5;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border 0.1s ease;
    }

    /* Couleurs par valeur (1-5) */
    .scale button[data-value="1"] { background:#ffb3b3; }  /* rouge clair */
    .scale button[data-value="2"] { background:#ffd5a6; }  /* orange */
    .scale button[data-value="3"] { background:#fff6a3; }  /* jaune */
    .scale button[data-value="4"] { background:#c9f7b5; }  /* vert clair */
    .scale button[data-value="5"] { background:#9ae69c; }  /* vert soutenu */

    .scale button.active {
      border: 2px solid #000;
      transform: scale(1.07);
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
    }

    .legend {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .actions button {
      padding: 16px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }
    .primary {
      background: #2f7ccc;
      color: #fff;
    }
    .secondary {
      background: #ddd;
    }
    .actions .danger {
      background: #b30000;
      color: #fff;
    }
    .actions .danger:hover {
      background: #d00000;
    }

    .result {
      margin-top: 15px;
      font-size: 16px;
      font-weight: bold;
      padding: 12px;
      border-radius: 10px;
    }

    .liste-joueurs ul {
      padding-left: 20px;
    }
    .liste-joueurs li {
      margin-bottom: 4px;
      padding: 4px 6px;
      border-radius: 6px;
    }

    /* Couleurs zones r√©sultat / liste - 5 zones */
    .zone-vert-fonce {
      background: #b7f0c4;
      color: #145c2e;
    }
    .zone-vert-clair {
      background: #d5f7dd;
      color: #1f7f3f;
    }
    .zone-jaune {
      background: #fff8c2;
      color: #8a7400;
    }
    .zone-orange {
      background: #ffe0b8;
      color: #8a4b06;
    }
    .zone-rouge {
      background: #f8d7da;
      color: #721c24;
    }

    /* Bloc bar√®me des zones */
    .bareme-container {
      margin-top: 25px;
      padding: 12px;
      background: #f5f9ff;
      border-radius: 10px;
      border: 1px solid #c7ddff;
      font-size: 13px;
    }
    .bareme-container h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 14px;
      color: #2f4f6f;
    }
    .bareme-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .bareme-table th,
    .bareme-table td {
      padding: 6px 8px;
      border: 1px solid #ddd;
    }
    .bareme-table th {
      background: #e3f1ff;
      text-align: left;
    }

    /* Stats bloc */
    .stats-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #2f4f6f;
    }
    .stats-line {
      font-size: 13px;
      margin-bottom: 4px;
    }
    .stats-bar-container {
      margin-top: 10px;
      font-size: 12px;
    }
    .stats-bar-row {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }
    .stats-bar-label {
      width: 110px;
      white-space: nowrap;
    }
    .stats-bar-bg {
      flex: 1;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .stats-bar-fill {
      height: 10px;
    }

    /* Indice bien-√™tre √©quipe */
    .stats-indice-box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      background: #f0f4ff;
      color: #2f4f6f;
    }
    .stats-indice-box.indice-vert {
      background: #b7f0c4;
      color: #145c2e;
    }
    .stats-indice-box.indice-jaune {
      background: #fff8c2;
      color: #8a7400;
    }
    .stats-indice-box.indice-orange {
      background: #ffe0b8;
      color: #8a4b06;
    }
    .stats-indice-box.indice-rouge {
      background: #f8d7da;
      color: #721c24;
    }

    .stats-reco {
      margin-top: 8px;
      font-size: 13px;
      color: #2f4f6f;
    }

    .stats-alertes {
      margin-top: 8px;
      font-size: 13px;
      color: #333;
    }

    /* Mode coach : sections cach√©es par d√©faut */
    .coach-only {
      display: none;
    }
    body.coach-mode .coach-only {
      display: block;
    }

    /* Stats √©quipe (2 graphiques Google Sheets) */
    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .stats-chart-card {
      flex: 1 1 280px;
      min-width: 260px;
    }

    .stats-chart-card h3 {
      font-size: 15px;
      margin-bottom: 8px;
      color: #2f4f6f;
      text-align: center;
    }

    .iframe-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .iframe-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    @media (max-width: 700px) {
      .stats-grid {
        flex-direction: column;
      }
      .iframe-container {
        aspect-ratio: 3 / 4;
      }
    }
  </style>
</head>
<body>

  <!-- BARRE DU HAUT : logo + titre + bouton mode coach -->
  <div class="top-bar">
    <div class="logo-container">
      <img src="logo_rcf.png" class="logo-rcf" alt="Logo RCF">
    </div>
    <div class="top-title">
      <h1>Test de Fatigue N3</h1>
      <h2>Questionnaire bien-√™tre avant l'entra√Ænement</h2>
    </div>
    <button
      type="button"
      id="modeCoachBtn"
      class="mode-toggle-btn"
      onclick="toggleModeCoach()"
      aria-pressed="false"
      aria-label="Basculer le mode coach"
    >
      Mode coach OFF
    </button>
  </div>

  <div class="layout">
    <!-- Colonne principale : formulaire -->
    <div class="card">
      <form id="fatigueForm">
        <!-- Joueur -->
        <div class="row">
          <label for="joueurSelect">Joueur :</label>
          <select id="joueurSelect" name="joueurSelect" required>
            <option value="">Choisir un joueur...</option>
            <option value="Ahmed">Ahmed</option>
            <option value="Axel">Axel</option>
            <option value="Amara">Amara</option>
            <option value="Bafod√©">Bafod√©</option>
            <option value="Christopher">Christopher</option>
            <option value="Damien">Damien</option>
            <option value="Emmanuel">Emmanuel</option>
            <option value="Elyon">Elyon</option>
            <option value="Ephrahim">Ephrahim</option>
            <option value="Fodi√©">Fodi√©</option>
            <option value="Gregory">Gregory</option>
            <option value="Hiendy">Hiendy</option>
            <option value="Henri Phillipe">Henri Phillipe</option>
            <option value="Ibrahim">Ibrahim</option>
            <option value="Kenny">Kenny</option>
            <option value="Kylian">Kylian</option>
            <option value="Lucas">Lucas</option>
            <option value="Malcom">Malcom</option>
            <option value="Marvin">Marvin</option>
            <option value="Micka√´l">Micka√´l</option>
            <option value="No√©">No√©</option>
            <option value="Sa√Ød">Sa√Ød</option>
            <option value="Salif">Salif</option>
            <option value="Simon">Simon</option>
            <option value="Vivien">Vivien</option>
            <option value="Wesley">Wesley</option>
            <option value="Yohan">Yohan</option>
            <option value="Youri">Youri</option>
            <option value="Autre">Autre (saisir le nom)</option>
          </select>
        </div>

        <div class="row" id="rowAutre" style="display:none;">
          <label for="joueurAutre">Nom joueur :</label>
          <input type="text" id="joueurAutre" name="joueurAutre" placeholder="Nom et pr√©nom" />
        </div>

        <!-- Date s√©ance (sans boutons -1/+1) -->
        <div class="row">
          <label for="seanceDate">Date de la s√©ance :</label>
          <input type="date" id="seanceDate" name="seanceDate">
        </div>

        <!-- Questions -->
        <div class="question">
          <label>Qualit√© du sommeil üò¥</label>
          <div class="scale" data-name="sommeil">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s mauvais sommeil &nbsp;&nbsp; 5 = Tr√®s bon sommeil</div>
          <input type="hidden" name="sommeil" />
        </div>

        <div class="question">
          <label>Douleurs musculaires üí¢</label>
          <div class="scale" data-name="douleurs">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s fortes douleurs &nbsp;&nbsp; 5 = Aucune douleur</div>
          <input type="hidden" name="douleurs" />
        </div>

        <div class="question">
          <label>Stress g√©n√©ral üò¨</label>
          <div class="scale" data-name="stress">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s stress√© &nbsp;&nbsp; 5 = Tr√®s d√©tendu</div>
          <input type="hidden" name="stress" />
        </div>

        <div class="question">
          <label>Fatigue g√©n√©rale üí§</label>
          <div class="scale" data-name="fatigue">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s fatigu√© &nbsp;&nbsp; 5 = Tr√®s en forme</div>
          <input type="hidden" name="fatigue" />
        </div>

        <div class="question">
          <label>Motivation ‚öΩ</label>
          <div class="scale" data-name="motivation">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Pas motiv√© &nbsp;&nbsp; 5 = Tr√®s motiv√©</div>
          <input type="hidden" name="motivation" />
        </div>

        <!-- Douleurs sp√©cifiques -->
        <div class="row">
          <label for="douleurZone">Douleurs sp√©cifiques :</label>
          <input type="text" id="douleurZone" name="douleurZone"
                 placeholder="Ex : ischios droit, adducteurs, cheville gauche..." />
        </div>

        <!-- Commentaire -->
        <div class="row">
          <label for="commentaire">Commentaire :</label>
          <textarea id="commentaire" name="commentaire"
                    placeholder="Comment tu te sens, remarque pour le staff..."></textarea>
        </div>

        <!-- Boutons -->
        <div class="actions">
          <button type="button" class="primary" onclick="enregistrerJoueur()">Enregistrer le joueur</button>
          <button type="button" class="primary coach-only" onclick="syncGoogleSheets()">Envoyer les donn√©es vers Google Sheets</button>
          <button type="button" class="secondary" onclick="resetForm(true)">Effacer le formulaire</button>
          <button type="button" class="secondary danger coach-only" onclick="resetDonnees()">Effacer tous les enregistrements (staff)</button>
        </div>

        <div class="result" id="resultat"></div>
      </form>

      <div class="liste-joueurs coach-only" id="listeJoueurs">
        <strong>Joueurs enregistr√©s (historique) :</strong>
        <ul id="listeJoueursUl"></ul>
      </div>

      <!-- Bar√®me -->
      <div class="bareme-container coach-only">
        <h3>Bar√®me des zones de fatigue (par joueur)</h3>
        <table class="bareme-table">
          <tr>
            <th>Zone</th>
            <th>Score total</th>
            <th>% sur 25</th>
            <th>Interpr√©tation</th>
            <th>Action staff</th>
          </tr>
          <tr class="zone-vert-fonce">
            <td>VERT FONC√â</td>
            <td>22 ‚Äì 25</td>
            <td>‚â• 88%</td>
            <td>Tr√®s bon √©tat g√©n√©ral</td>
            <td>Charge normale / haute</td>
          </tr>
          <tr class="zone-vert-clair">
            <td>VERT CLAIR</td>
            <td>19 ‚Äì 21</td>
            <td>76 ‚Äì 84%</td>
            <td>Bon √©tat, l√©g√®re fatigue normale</td>
            <td>Charge normale</td>
          </tr>
          <tr class="zone-jaune">
            <td>JAUNE</td>
            <td>16 ‚Äì 18</td>
            <td>64 ‚Äì 72%</td>
            <td>Fatigue l√©g√®re √† surveiller</td>
            <td>Charge mod√©r√©e</td>
          </tr>
          <tr class="zone-orange">
            <td>ORANGE</td>
            <td>13 ‚Äì 15</td>
            <td>52 ‚Äì 60%</td>
            <td>Fatigue notable, r√©cup√©ration insuffisante</td>
            <td>Charge all√©g√©e / adaptation</td>
          </tr>
          <tr class="zone-rouge">
            <td>ROUGE</td>
            <td>5 ‚Äì 12</td>
            <td>&lt; 52%</td>
            <td>Fatigue importante / alerte</td>
            <td>Charge tr√®s r√©duite, individualisation</td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Colonne lat√©rale : stats s√©ance -->
    <div class="stats-card coach-only">
      <div class="stats-title">Synth√®se rapide (derni√®re saisie par joueur)</div>
      <div class="stats-line" id="statsNbJoueurs">Joueurs (derni√®re mesure) : 0</div>
      <div class="stats-line" id="statsMoyenneScore">Score moyen : -</div>
      <div class="stats-line" id="statsZoneDom">Zone dominante : -</div>

      <!-- Indice bien-√™tre √©quipe -->
      <div class="stats-indice-box" id="statsIndiceBox">
        <div id="statsIndiceLabel">Indice bien-√™tre √©quipe : -</div>
      </div>

      <!-- Recommandation s√©ance -->
      <div class="stats-line stats-reco" id="statsRecoSeance">
        Recommandation s√©ance : -
      </div>

      <!-- Joueurs en alerte -->
      <div class="stats-alertes">
        <div class="stats-line"><strong>Joueurs en alerte (orange/rouge) :</strong></div>
        <div class="stats-line" id="statsAlertesListe">-</div>
      </div>

      <!-- R√©partition zones -->
      <div class="stats-bar-container">
        <div class="stats-bar-row">
          <div class="stats-bar-label">Tr√®s bon √©tat</div>
          <div class="stats-bar-bg"><div id="barVFonce" class="stats-bar-fill zone-vert-fonce" style="width:0%"></div></div>
          <div id="textVFonce">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Bon √©tat</div>
          <div class="stats-bar-bg"><div id="barVClair" class="stats-bar-fill zone-vert-clair" style="width:0%"></div></div>
          <div id="textVClair">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Fatigue l√©g√®re</div>
          <div class="stats-bar-bg"><div id="barJaune" class="stats-bar-fill zone-jaune" style="width:0%"></div></div>
          <div id="textJaune">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Fatigue notable</div>
          <div class="stats-bar-bg"><div id="barOrange" class="stats-bar-fill zone-orange" style="width:0%"></div></div>
          <div id="textOrange">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Fatigue importante</div>
          <div class="stats-bar-bg"><div id="barRouge" class="stats-bar-fill zone-rouge" style="width:0%"></div></div>
          <div id="textRouge">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    let enregistrements = [];

    const STORAGE_KEY = "test_fatigue_rcf_enregistrements_v1";
    const selectJoueur = document.getElementById("joueurSelect");
    const rowAutre = document.getElementById("rowAutre");
    const inputAutre = document.getElementById("joueurAutre");
    const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbyrlLJn8rtbpoDnzvMSKL26osTeoEM3vM3UX51JUn3FFS9jHPN-3iF5uYztcjJTo_g/exec";

    // Affichage champ "Autre joueur"
    selectJoueur.addEventListener("change", () => {
      if (selectJoueur.value === "Autre") {
        rowAutre.style.display = "flex";
      } else {
        rowAutre.style.display = "none";
        inputAutre.value = "";
      }
    });

    // Boutons 1‚Äì5 -> hidden inputs
    document.querySelectorAll(".scale").forEach(scale => {
      const name = scale.getAttribute("data-name");
      const hiddenInput = document.querySelector('input[name="' + name + '"]');
      scale.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          scale.querySelectorAll("button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          hiddenInput.value = btn.getAttribute("data-value");
        });
      });
    });

    function getNomJoueur() {
      const valSelect = selectJoueur.value;
      if (!valSelect) return "";
      if (valSelect === "Autre") {
        return inputAutre.value.trim();
      }
      return valSelect;
    }

    function getSeance() {
      const inputDate = document.getElementById("seanceDate");
      const valDate = inputDate.value;
      if (!valDate) return "";
      const jours = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
      const d = new Date(valDate + "T00:00:00");
      const jour = jours[d.getDay()];
      return valDate + " (" + jour + ")";
    }

    function initDateSeance() {
      const inputDate = document.getElementById("seanceDate");
      if (!inputDate) return;

      const aujourdHui = new Date();
      const annee = aujourdHui.getFullYear();
      const mois = String(aujourdHui.getMonth() + 1).padStart(2, "0");
      const jour = String(aujourdHui.getDate()).padStart(2, "0");

      inputDate.value = annee + "-" + mois + "-" + jour;
    }

    // Basculer Mode Coach
    function toggleModeCoach() {
      const body = document.body;
      const btn = document.getElementById("modeCoachBtn");
      body.classList.toggle("coach-mode");

      if (body.classList.contains("coach-mode")) {
        btn.classList.add("coach-on");
        btn.setAttribute("aria-pressed", "true");
        btn.textContent = "Mode coach ON";
      } else {
        btn.classList.remove("coach-on");
        btn.setAttribute("aria-pressed", "false");
        btn.textContent = "Mode coach OFF";
      }
    }

    // Envoi d'un enregistrement vers Google Sheets
    function envoyerVersGoogleSheets(rec) {
      if (!GOOGLE_SHEETS_URL) {
        console.warn("Pas d'URL Google Sheets d√©finie");
        return;
      }

      if (!navigator.onLine) {
        console.log("Hors connexion, envoi report√©.");
        return;
      }

      const payload = Object.assign({}, rec);
      delete payload.envoye;

      console.log("Envoi vers Google Sheets (no-cors) :", payload);

      fetch(GOOGLE_SHEETS_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
      })
      .then(() => {
        rec.envoye = true;
        sauvegarderDansStorage();
        console.log("Envoi lanc√© pour", rec.joueur, rec.seance);
      })
      .catch(err => {
        console.warn("Erreur r√©seau envoi Google Sheets :", err);
      });
    }

    // Envoi de tous les enregistrements non envoy√©s
    function syncGoogleSheets() {
      if (!navigator.onLine) {
        alert("La tablette n'est pas connect√©e √† Internet.\nConnecte-toi au Wi-Fi puis r√©essaie.");
        return;
      }

      const aEnvoyer = enregistrements.filter(r => !r.envoye);

      if (aEnvoyer.length === 0) {
        alert("Toutes les donn√©es locales ont d√©j√† √©t√© envoy√©es vers Google Sheets.");
        return;
      }

      if (!confirm("Envoyer " + aEnvoyer.length + " r√©ponses vers Google Sheets ?")) {
        return;
      }

      aEnvoyer.forEach(rec => {
        const payload = Object.assign({}, rec);
        delete payload.envoye;

        fetch(GOOGLE_SHEETS_URL, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify(payload)
        })
        .then(() => {
          rec.envoye = true;
          sauvegarderDansStorage();
        })
        .catch(err => {
          console.warn("Erreur r√©seau (sync) pour", rec.joueur, rec.seance, err);
        });
      });

      alert(
        "Synchronisation lanc√©e.\n" +
        aEnvoyer.length + " r√©ponses envoy√©es vers Google Sheets (no-cors).\n" +
        "V√©rifie dans le Google Sheet apr√®s quelques secondes."
      );
    }

    function enregistrerJoueur() {
      const form = document.getElementById("fatigueForm");

      const joueur = getNomJoueur();
      if (!joueur) {
        alert("Merci de s√©lectionner un joueur ou de saisir son nom.");
        return;
      }

      const seance = getSeance();

      const dejaFait = enregistrements.some(rec =>
        rec.joueur === joueur &&
        (rec.seance || "") === (seance || "")
      );
      if (dejaFait) {
        alert("‚ö†Ô∏è Ce joueur a d√©j√† rempli le test pour cette s√©ance.");
        return;
      }

      const champs = [
        { name: "sommeil",    label: "Qualit√© du sommeil" },
        { name: "douleurs",   label: "Douleurs musculaires" },
        { name: "stress",     label: "Stress g√©n√©ral" },
        { name: "fatigue",    label: "Fatigue g√©n√©rale" },
        { name: "motivation", label: "Motivation" }
      ];

      const valeurs = {};
      for (const champ of champs) {
        const val = form[champ.name].value;
        if (!val) {
          alert('Merci de r√©pondre √† la question : "' + champ.label + '" (1 √† 5).');
          return;
        }
        valeurs[champ.name] = Number(val);
      }

      const date = new Date().toLocaleString();
      const sommeil = valeurs["sommeil"];
      const douleurs = valeurs["douleurs"];
      const stress = valeurs["stress"];
      const fatigue = valeurs["fatigue"];
      const motivation = valeurs["motivation"];
      const douleurZone = document.getElementById("douleurZone").value.trim();
      const commentaire = document.getElementById("commentaire").value.trim();

      const total = sommeil + douleurs + stress + fatigue + motivation;
      const pourcentage = Math.round((total / 25) * 100);

      let zoneTexte = "";
      let zoneClass = "";

      if (pourcentage >= 88) {
        zoneTexte = "VERT FONCE tres bon etat (22-25)";
        zoneClass = "zone-vert-fonce";
      } else if (pourcentage >= 76) {
        zoneTexte = "VERT CLAIR bon etat general (19-21)";
        zoneClass = "zone-vert-clair";
      } else if (pourcentage >= 64) {
        zoneTexte = "JAUNE fatigue legere (16-18)";
        zoneClass = "zone-jaune";
      } else if (pourcentage >= 52) {
        zoneTexte = "ORANGE fatigue notable (13-15)";
        zoneClass = "zone-orange";
      } else {
        zoneTexte = "ROUGE fatigue importante (5-12)";
        zoneClass = "zone-rouge";
      }

      const record = {
        date,
        joueur,
        seance,
        sommeil,
        douleurs,
        stress,
        fatigue,
        motivation,
        total,
        pourcentage,
        zone: zoneTexte,
        zoneClass: zoneClass,
        douleurZone,
        commentaire,
        envoye: false
      };

      enregistrements.push(record);
      sauvegarderDansStorage();

      if (navigator.onLine) {
        envoyerVersGoogleSheets(record);
      } else {
        console.log("Pas de connexion : r√©ponse sauvegard√©e uniquement en local.");
      }

      const resultatDiv = document.getElementById("resultat");
      resultatDiv.textContent =
        "Enregistr√© : " + joueur + " | S√©ance : " + (seance || "non pr√©cis√©") +
        " | Score : " + total + "/25 (" + pourcentage + "%) - Zone : " + zoneTexte +
        " | Total formulaires : " + enregistrements.length;
      resultatDiv.className = "result " + zoneClass;

      majListeJoueurs();
      majStats();
      resetForm(false);
    }

    function majListeJoueurs() {
      const ul = document.getElementById("listeJoueursUl");
      if (!ul) return;
      ul.innerHTML = "";

      enregistrements.forEach((rec, index) => {
        const li = document.createElement("li");

        let badge = "";
        if (rec.envoye) {
          badge = " üü¢ (envoy√©)";
        } else {
          badge = " üî¥ (en attente)";
        }

        li.textContent =
          (index + 1) + ". " +
          rec.joueur + " - " +
          rec.pourcentage + "% (" + rec.zone + ")" +
          (rec.seance ? " | " + rec.seance : "") +
          badge;

        li.className = rec.zoneClass;
        ul.appendChild(li);
      });
    }

    // Stats sur la DERNI√àRE saisie de chaque joueur
    function majStats() {
      const elNb = document.getElementById("statsNbJoueurs");
      const elMoy = document.getElementById("statsMoyenneScore");
      const elDom = document.getElementById("statsZoneDom");
      const indiceBox = document.getElementById("statsIndiceBox");
      const indiceLabel = document.getElementById("statsIndiceLabel");
      const recoEl = document.getElementById("statsRecoSeance");
      const alertesEl = document.getElementById("statsAlertesListe");

      // Construire un tableau "derni√®re saisie par joueur"
      const dernierParJoueur = {};
      enregistrements.forEach(rec => {
        dernierParJoueur[rec.joueur] = rec; // le dernier dans le tableau gagne
      });
      const liste = Object.values(dernierParJoueur);
      const nb = liste.length;

      if (elNb) elNb.textContent = "Joueurs (derni√®re mesure) : " + nb;

      if (nb === 0) {
        if (elMoy) elMoy.textContent = "Score moyen : -";
        if (elDom) elDom.textContent = "Zone dominante : -";
        if (indiceBox && indiceLabel) {
          indiceBox.className = "stats-indice-box";
          indiceLabel.textContent = "Indice bien-√™tre √©quipe : -";
        }
        if (recoEl) recoEl.textContent = "Recommandation s√©ance : -";
        if (alertesEl) alertesEl.textContent = "-";

        ["VFonce","VClair","Jaune","Orange","Rouge"].forEach(z => {
          const bar = document.getElementById("bar"+z);
          const txt = document.getElementById("text"+z);
          if (bar) bar.style.width = "0%";
          if (txt) txt.textContent = "0";
        });
        return;
      }

      let sommeScores = 0;
      const compteZones = { vf:0, vc:0, j:0, o:0, r:0 };

      liste.forEach(rec => {
        sommeScores += rec.total;
        if (rec.zoneClass === "zone-vert-fonce") compteZones.vf++;
        else if (rec.zoneClass === "zone-vert-clair") compteZones.vc++;
        else if (rec.zoneClass === "zone-jaune") compteZones.j++;
        else if (rec.zoneClass === "zone-orange") compteZones.o++;
        else if (rec.zoneClass === "zone-rouge") compteZones.r++;
      });

      const moyScore = (sommeScores / nb).toFixed(1);
      if (elMoy) elMoy.textContent = "Score moyen : " + moyScore + " / 25";

      // Zone dominante
      const zonesOrdre = [
        { code:"vf", nom:"VERT FONC√â" },
        { code:"vc", nom:"VERT CLAIR" },
        { code:"j",  nom:"JAUNE" },
        { code:"o",  nom:"ORANGE" },
        { code:"r",  nom:"ROUGE" }
      ];
      let maxZone = null;
      let maxVal = -1;
      zonesOrdre.forEach(z => {
        if (compteZones[z.code] > maxVal) {
          maxVal = compteZones[z.code];
          maxZone = z.nom;
        }
      });
      if (elDom) elDom.textContent = "Zone dominante : " + maxZone + " (" + maxVal + " joueurs)";

      const pct = code => Math.round((compteZones[code] / nb) * 100);

      const barVF = document.getElementById("barVFonce");
      const txtVF = document.getElementById("textVFonce");
      if (barVF) barVF.style.width = pct("vf") + "%";
      if (txtVF) txtVF.textContent = compteZones.vf;

      const barVC = document.getElementById("barVClair");
      const txtVC = document.getElementById("textVClair");
      if (barVC) barVC.style.width = pct("vc") + "%";
      if (txtVC) txtVC.textContent = compteZones.vc;

      const barJ = document.getElementById("barJaune");
      const txtJ = document.getElementById("textJaune");
      if (barJ) barJ.style.width = pct("j") + "%";
      if (txtJ) txtJ.textContent = compteZones.j;

      const barO = document.getElementById("barOrange");
      const txtO = document.getElementById("textOrange");
      if (barO) barO.style.width = pct("o") + "%";
      if (txtO) txtO.textContent = compteZones.o;

      const barR = document.getElementById("barRouge");
      const txtR = document.getElementById("textRouge");
      if (barR) barR.style.width = pct("r") + "%";
      if (txtR) txtR.textContent = compteZones.r;

      // Indice bien-√™tre √©quipe (en %)
      const moyScoreNum = parseFloat(moyScore);
      const pctEquipe = Math.round((moyScoreNum / 25) * 100);

      let classeIndice = "";
      let texteZoneEquipe = "";

      if (pctEquipe >= 88) {
        classeIndice = "indice-vert";
        texteZoneEquipe = "Tr√®s bon √©tat g√©n√©ral";
      } else if (pctEquipe >= 76) {
        classeIndice = "indice-vert";
        texteZoneEquipe = "Bon √©tat g√©n√©ral";
      } else if (pctEquipe >= 64) {
        classeIndice = "indice-jaune";
        texteZoneEquipe = "Fatigue l√©g√®re";
      } else if (pctEquipe >= 52) {
        classeIndice = "indice-orange";
        texteZoneEquipe = "Fatigue notable";
      } else {
        classeIndice = "indice-rouge";
        texteZoneEquipe = "Fatigue importante";
      }

      if (indiceBox && indiceLabel) {
        indiceBox.className = "stats-indice-box " + classeIndice;
        indiceLabel.textContent =
          "Indice bien-√™tre √©quipe : " + pctEquipe + "% ‚Äì " + texteZoneEquipe;
      }

      // Joueurs en alerte (orange/rouge)
      const alertes = liste
        .filter(rec => rec.zoneClass === "zone-orange" || rec.zoneClass === "zone-rouge")
        .map(rec => rec.joueur);

      if (alertesEl) {
        if (alertes.length === 0) {
          alertesEl.textContent = "Aucun joueur en alerte (orange/rouge) sur la derni√®re mesure.";
        } else {
          alertesEl.textContent = alertes.join(", ");
        }
      }

      // Recommandation s√©ance
      const nbRougeOrange = compteZones.o + compteZones.r;
      const pctRougeOrange = Math.round((nbRougeOrange / nb) * 100);

      let reco = "";

      if (pctEquipe >= 80 && pctRougeOrange <= 10) {
        reco = "√âquipe globalement en forme : tu peux maintenir la charge pr√©vue, voire l'augmenter l√©g√®rement.";
      } else if (pctEquipe >= 70 && pctRougeOrange <= 25) {
        reco = "Fatigue mod√©r√©e : maintiens la s√©ance pr√©vue mais surveille les joueurs en orange/rouge.";
      } else if (pctEquipe >= 60 || pctRougeOrange > 30) {
        reco = "Plusieurs joueurs fatigu√©s : r√©duis le volume ou l'intensit√©, individualise pour les joueurs en alerte.";
      } else {
        reco = "Fatigue √©lev√©e : s√©ance all√©g√©e / r√©cup√©ration active, attention particuli√®re aux joueurs les plus en difficult√©.";
      }

      if (recoEl) {
        recoEl.textContent = "Recommandation s√©ance : " + reco;
      }
    }

    function resetForm(clearResult) {
      const form = document.getElementById("fatigueForm");
      form.reset();
      rowAutre.style.display = "none";
      inputAutre.value = "";

      document.querySelectorAll(".scale button").forEach(b => b.classList.remove("active"));

      document.querySelectorAll('input[type="hidden"]').forEach(input => {
        input.value = "";
      });

      if (clearResult) {
        const resultatDiv = document.getElementById("resultat");
        resultatDiv.textContent = "";
        resultatDiv.className = "result";
      }
    }

    function sauvegarderDansStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(enregistrements));
      } catch (e) {
        console.warn("Impossible de sauvegarder dans le stockage local :", e);
      }
    }

    function chargerDepuisStorage() {
      const data = localStorage.getItem(STORAGE_KEY);

      if (!data) {
        enregistrements = [];
        majListeJoueurs();
        majStats();
        return;
      }

      try {
        const parsed = JSON.parse(data);
        if (Array.isArray(parsed)) {
          enregistrements = parsed;
        } else {
          enregistrements = [];
        }
      } catch (e) {
        console.warn("Donn√©es locales corrompues, on repart √† z√©ro :", e);
        enregistrements = [];
      }

      majListeJoueurs();
      majStats();
    }

    function resetDonnees() {
      if (!confirm("Supprimer TOUTES les r√©ponses enregistr√©es sur cette tablette ?")) return;
      enregistrements = [];
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.warn("Impossible d'effacer le stockage local :", e);
      }
      majListeJoueurs();
      majStats();
      resetForm(true);
      alert("Tous les enregistrements ont √©t√© effac√©s.");
    }

    // init
    chargerDepuisStorage();
    initDateSeance();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker enregistr√©"))
        .catch(err => console.log("Erreur SW:", err));
    }
  </script>

  <!-- SECTION GRAPHIQUES GOOGLE SHEETS (MODE COACH UNIQUEMENT) -->
  <section id="stats-equipe" class="card coach-only" style="margin-top:20px;">
    <h2>Statistiques √©quipe (Google Sheets)</h2>

    <div class="stats-grid">
      <!-- üî¥ TOP 5 FATIGU√âS -->
      <div class="stats-chart-card">
        <h3>Top 5 joueurs les plus fatigu√©s</h3>
        <div class="iframe-container">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSZOoAxXWypXm2R1xpiBnnW7CZ_qYsAuB3_OIZbcrspuwPy8iYjWmOlouo5gPhskbbRB5RZVFC2WBL5/pubchart?oid=1899617904&format=interactive"
            loading="lazy"
            allowfullscreen
          ></iframe>
        </div>
      </div>

      <!-- üü¢ TOP 5 EN FORME -->
      <div class="stats-chart-card">
        <h3>Top 5 joueurs les plus en forme</h3>
        <div class="iframe-container">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSZOoAxXWypXm2R1xpiBnnW7CZ_qYsAuB3_OIZbcrspuwPy8iYjWmOlouo5gPhskbbRB5RZVFC2WBL5/pubchart?oid=2032210019&format=interactive"
            loading="lazy"
            allowfullscreen
          ></iframe>
        </div>
      </div>
    </div>
  </section>

</body>
</html>
