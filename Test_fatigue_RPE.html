<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test de Fatigue RCF</title>

  <!-- Librairie Excel (si tu la r√©actives un jour) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2f7ccc">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #e3f1ff;
      font-size: 18px;
    }

    /* ---------- TOP BAR ---------- */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .logo-container {
      display: flex;
      align-items: center;
      flex: 0 0 auto;
    }
    .logo-rcf {
      max-width: 60px;
      height: auto;
    }
    .top-title {
      flex: 1 1 auto;
      text-align: center;
    }
    h1 {
      margin: 0;
      color: #2f7ccc;
      font-size: 26px;
    }
    h2 {
      margin: 0;
      font-size: 16px;
      color: #4a6580;
    }

    /* Bouton Mode Coach */
    .mode-toggle-btn {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(145deg, #3f82cf, #1f5ba8);
      color: #fff;
      box-shadow: 0 3px 6px rgba(0,0,0,0.25);
      opacity: 0.85;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s ease, background 0.2s ease;
      white-space: nowrap;
    }
    .mode-toggle-btn:hover {
      opacity: 1;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }
    .mode-toggle-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .mode-toggle-btn.coach-on {
      background: linear-gradient(145deg, #12b886, #0f8f66);
    }

    /* ---------- LAYOUT ---------- */
    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 2px solid #6bb4ff;
      flex: 2 1 540px;
      min-width: 0;
    }
    .stats-card {
      background: #fff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 2px solid #6bb4ff;
      flex: 1 1 260px;
      min-width: 0;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      align-items: center;
    }
    .row label {
      font-weight: bold;
      flex: 1 0 140px;
      font-size: 16px;
    }
    .row input[type="text"],
    .row input[type="date"],
    .row select,
    .row textarea {
      flex: 2 1 200px;
      padding: 12px;
      font-size: 18px;
      border-radius: 10px;
      border: 1px solid #ccc;
      min-height: 46px;
    }
    textarea { min-height: 60px; resize: vertical; }

    .question { margin-bottom: 22px; }
    .question > label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    .scale {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      margin-top: 8px;
    }
    .scale button {
      flex: 1 0 18%;
      padding: 16px 0;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 22px;
      cursor: pointer;
      background: #f5f5f5;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border 0.1s ease;
    }
    .scale button[data-value="1"] { background:#ffb3b3; }
    .scale button[data-value="2"] { background:#ffd5a6; }
    .scale button[data-value="3"] { background:#fff6a3; }
    .scale button[data-value="4"] { background:#c9f7b5; }
    .scale button[data-value="5"] { background:#9ae69c; }

    .scale button.active {
      border: 2px solid #000;
      transform: scale(1.07);
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
    }

    .legend {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .actions button {
      padding: 16px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }
    .primary { background: #2f7ccc; color: #fff; }
    .secondary { background: #ddd; }
    .danger { background: #b30000; color: #fff; }
    .danger:hover { background: #d00000; }

    .result {
      margin-top: 15px;
      font-size: 16px;
      font-weight: bold;
      padding: 12px;
      border-radius: 10px;
    }

    .liste-joueurs ul { padding-left: 20px; }
    .liste-joueurs li {
      margin-bottom: 4px;
      padding: 4px 6px;
      border-radius: 6px;
    }

    /* Zones */
    .zone-vert-fonce { background: #b7f0c4; color: #145c2e; }
    .zone-vert-clair { background: #d5f7dd; color: #1f7f3f; }
    .zone-jaune      { background: #fff8c2; color: #8a7400; }
    .zone-orange     { background: #ffe0b8; color: #8a4b06; }
    .zone-rouge      { background: #f8d7da; color: #721c24; }

    /* Coach-only */
    .coach-only { display: none; }
    body.coach-mode .coach-only { display: block; }

    /* Stats √©quipe (graphiques) */
    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }
    .stats-chart-card { flex: 1 1 280px; min-width: 260px; }
    .stats-chart-card h3 {
      font-size: 15px;
      margin-bottom: 8px;
      color: #2f4f6f;
      text-align: center;
    }

    .iframe-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .iframe-container iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
    @media (max-width: 700px) {
      .stats-grid { flex-direction: column; }
      .iframe-container { aspect-ratio: 3 / 4; }
    }
  </style>
</head>

<body>

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="logo-container">
      <img src="logo_rcf.png" class="logo-rcf" alt="Logo RCF">
    </div>

    <div class="top-title">
      <h1>Test de Fatigue N3</h1>
      <h2>Questionnaire bien-√™tre avant l'entra√Ænement</h2>
    </div>

    <button
      type="button"
      id="modeCoachBtn"
      class="mode-toggle-btn"
      onclick="toggleModeCoach()"
      aria-pressed="false">
      Mode coach OFF
    </button>
  </div>

  <div class="layout">

    <!-- FORMULAIRE -->
    <div class="card">
      <form id="fatigueForm">

        <!-- Joueur -->
        <div class="row">
          <label for="joueurSelect">Joueur :</label>
          <select id="joueurSelect" name="joueurSelect" required>
            <option value="">Choisir un joueur...</option>
            <option value="Ahmed">Ahmed</option>
            <option value="Axel">Axel</option>
            <option value="Amara">Amara</option>
            <option value="Bafod√©">Bafod√©</option>
            <option value="Christopher">Christopher</option>
            <option value="Damien">Damien</option>
            <option value="Emmanuel">Emmanuel</option>
            <option value="Elyon">Elyon</option>
            <option value="Ephrahim">Ephrahim</option>
            <option value="Fodi√©">Fodi√©</option>
            <option value="Gregory">Gregory</option>
            <option value="Hiendy">Hiendy</option>
            <option value="Henri Phillipe">Henri Phillipe</option>
            <option value="Ibrahim">Ibrahim</option>
            <option value="Kenny">Kenny</option>
            <option value="Kylian">Kylian</option>
            <option value="Lucas">Lucas</option>
            <option value="Malcom">Malcom</option>
            <option value="Marvin">Marvin</option>
            <option value="Micka√´l">Micka√´l</option>
            <option value="No√©">No√©</option>
            <option value="Sa√Ød">Sa√Ød</option>
            <option value="Salif">Salif</option>
            <option value="Simon">Simon</option>
            <option value="Vivien">Vivien</option>
            <option value="Wesley">Wesley</option>
            <option value="Yohan">Yohan</option>
            <option value="Youri">Youri</option>
            <option value="Autre">Autre (saisir le nom)</option>
          </select>
        </div>

        <div class="row" id="rowAutre" style="display:none;">
          <label for="joueurAutre">Nom joueur :</label>
          <input type="text" id="joueurAutre" name="joueurAutre" placeholder="Nom et pr√©nom" />
        </div>

        <!-- Date s√©ance -->
        <div class="row">
          <label for="seanceDate">Date de la s√©ance :</label>
          <input type="date" id="seanceDate" name="seanceDate">
        </div>

        <!-- QUESTIONS NOUVELLES -->
        <div class="question">
          <label>Qualit√© de la r√©cup√©ration depuis le dernier match üßä</label>
          <div class="scale" data-name="recuperation">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s mauvaise r√©cup &nbsp;&nbsp; 5 = Tr√®s bonne r√©cup</div>
          <input type="hidden" name="recuperation" />
        </div>

        <div class="question">
          <label>Qualit√© du sommeil üò¥</label>
          <div class="scale" data-name="sommeil">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s mauvais &nbsp;&nbsp; 5 = Tr√®s bon</div>
          <input type="hidden" name="sommeil" />
        </div>

        <div class="question">
          <label>Qualit√© alimentation / hydratation (24h) ü•óüíß</label>
          <div class="scale" data-name="alimentation">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s mauvaise &nbsp;&nbsp; 5 = Tr√®s bonne</div>
          <input type="hidden" name="alimentation" />
        </div>

        <div class="question">
          <label>Fatigue physique / douleurs musculaires üí¢</label>
          <div class="scale" data-name="fatigue_physique">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s fatigu√©/douloureux &nbsp;&nbsp; 5 = Tr√®s en forme</div>
          <input type="hidden" name="fatigue_physique" />
        </div>

        <div class="question">
          <label>Fatigue mentale üß†</label>
          <div class="scale" data-name="fatigue_mentale">
            <button type="button" data-value="1">1</button>
            <button type="button" data-value="2">2</button>
            <button type="button" data-value="3">3</button>
            <button type="button" data-value="4">4</button>
            <button type="button" data-value="5">5</button>
          </div>
          <div class="legend">1 = Tr√®s fatigu√© mentalement &nbsp;&nbsp; 5 = Tr√®s frais</div>
          <input type="hidden" name="fatigue_mentale" />
        </div>

        <!-- Bonus staff (coach only) -->
        <div class="row coach-only">
          <label for="bonusStaff">Bonus staff :</label>
          <input type="text" id="bonusStaff" name="bonusStaff"
                 placeholder="Ex : attention adducteurs, charge r√©duite, etc.">
        </div>

        <!-- Douleurs sp√©cifiques -->
        <div class="row">
          <label for="douleurZone">Douleurs sp√©cifiques :</label>
          <input type="text" id="douleurZone" name="douleurZone"
                 placeholder="Ex : ischios droit, adducteurs, cheville gauche..." />
        </div>

        <!-- Commentaire joueur -->
        <div class="row">
          <label for="commentaire">Commentaire :</label>
          <textarea id="commentaire" name="commentaire"
                    placeholder="Comment tu te sens, remarque pour le staff..."></textarea>
        </div>

        <!-- Boutons -->
        <div class="actions">
          <button type="button" class="primary" onclick="enregistrerJoueur()">Enregistrer le joueur</button>
          <button type="button" class="primary coach-only" onclick="syncGoogleSheets()">Envoyer vers Google Sheets</button>
          <button type="button" class="secondary" onclick="resetForm(true)">Effacer le formulaire</button>
          <button type="button" class="secondary danger coach-only" onclick="resetDonnees()">Effacer tous les enregistrements</button>
        </div>

        <div class="result" id="resultat"></div>
      </form>

      <div class="liste-joueurs coach-only">
        <strong>Historique local :</strong>
        <ul id="listeJoueursUl"></ul>
      </div>
    </div>

    <!-- STATS COACH -->
    <div class="stats-card coach-only">
      <div class="stats-title">Synth√®se rapide (derni√®re saisie)</div>
      <div class="stats-line" id="statsNbJoueurs">Joueurs (derni√®re mesure) : 0</div>
      <div class="stats-line" id="statsMoyenneScore">Score moyen : -</div>
      <div class="stats-line" id="statsZoneDom">Zone dominante : -</div>

      <div class="stats-indice-box" id="statsIndiceBox">
        <div id="statsIndiceLabel">Indice bien-√™tre √©quipe : -</div>
      </div>

      <div class="stats-line stats-reco" id="statsRecoSeance">
        Recommandation s√©ance : -
      </div>

      <div class="stats-alertes">
        <div class="stats-line"><strong>Joueurs en alerte (orange/rouge) :</strong></div>
        <div class="stats-line" id="statsAlertesListe">-</div>
      </div>

      <div class="stats-bar-container">
        <div class="stats-bar-row">
          <div class="stats-bar-label">Tr√®s bon √©tat</div>
          <div class="stats-bar-bg"><div id="barVFonce" class="stats-bar-fill zone-vert-fonce" style="width:0%"></div></div>
          <div id="textVFonce">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Bon √©tat</div>
          <div class="stats-bar-bg"><div id="barVClair" class="stats-bar-fill zone-vert-clair" style="width:0%"></div></div>
          <div id="textVClair">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Fatigue l√©g√®re</div>
          <div class="stats-bar-bg"><div id="barJaune" class="stats-bar-fill zone-jaune" style="width:0%"></div></div>
          <div id="textJaune">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Fatigue notable</div>
          <div class="stats-bar-bg"><div id="barOrange" class="stats-bar-fill zone-orange" style="width:0%"></div></div>
          <div id="textOrange">0</div>
        </div>
        <div class="stats-bar-row">
          <div class="stats-bar-label">Fatigue importante</div>
          <div class="stats-bar-bg"><div id="barRouge" class="stats-bar-fill zone-rouge" style="width:0%"></div></div>
          <div id="textRouge">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    let enregistrements = [];

    const STORAGE_KEY = "test_fatigue_rcf_enregistrements_v1";
    const selectJoueur = document.getElementById("joueurSelect");
    const rowAutre = document.getElementById("rowAutre");
    const inputAutre = document.getElementById("joueurAutre");
    const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbyrlLJn8rtbpoDnzvMSKL26osTeoEM3vM3UX51JUn3FFS9jHPN-3iF5uYztcjJTo_g/exec";

    // Autre joueur
    selectJoueur.addEventListener("change", () => {
      rowAutre.style.display = (selectJoueur.value === "Autre") ? "flex" : "none";
      if (selectJoueur.value !== "Autre") inputAutre.value = "";
    });

    // Scales -> hidden input
    document.querySelectorAll(".scale").forEach(scale => {
      const name = scale.getAttribute("data-name");
      const hiddenInput = document.querySelector(`input[name="${name}"]`);
      scale.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          scale.querySelectorAll("button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          hiddenInput.value = btn.getAttribute("data-value");
        });
      });
    });

    function getNomJoueur() {
      if (!selectJoueur.value) return "";
      if (selectJoueur.value === "Autre") return inputAutre.value.trim();
      return selectJoueur.value;
    }

    function getSeance() {
      const valDate = document.getElementById("seanceDate").value;
      if (!valDate) return "";
      const jours = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
      const d = new Date(valDate + "T00:00:00");
      return valDate + " (" + jours[d.getDay()] + ")";
    }

    function initDateSeance() {
      const inputDate = document.getElementById("seanceDate");
      const d = new Date();
      inputDate.value = d.toISOString().slice(0,10);
    }

    function toggleModeCoach() {
      const body = document.body;
      const btn = document.getElementById("modeCoachBtn");
      body.classList.toggle("coach-mode");

      const on = body.classList.contains("coach-mode");
      btn.classList.toggle("coach-on", on);
      btn.setAttribute("aria-pressed", on ? "true" : "false");
      btn.textContent = on ? "Mode coach ON" : "Mode coach OFF";
    }

    function envoyerVersGoogleSheets(rec) {
      if (!navigator.onLine) return;

      const payload = { ...rec };
      delete payload.envoye;

      fetch(GOOGLE_SHEETS_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
      }).then(() => {
        rec.envoye = true;
        sauvegarderDansStorage();
      }).catch(() => {});
    }

    function syncGoogleSheets() {
      if (!navigator.onLine) {
        alert("Pas de connexion Internet.");
        return;
      }

      const aEnvoyer = enregistrements.filter(r => !r.envoye);
      if (aEnvoyer.length === 0) {
        alert("Tout est d√©j√† synchronis√©.");
        return;
      }

      if (!confirm("Envoyer " + aEnvoyer.length + " r√©ponses ?")) return;

      aEnvoyer.forEach(r => envoyerVersGoogleSheets(r));

      alert("Synchronisation lanc√©e. V√©rifie Sheets dans 10‚Äì20 sec.");
    }

    function enregistrerJoueur() {
      const form = document.getElementById("fatigueForm");
      const joueur = getNomJoueur();
      if (!joueur) return alert("S√©lectionne un joueur.");

      const seance = getSeance();

      const dejaFait = enregistrements.some(rec =>
        rec.joueur === joueur && (rec.seance || "") === (seance || "")
      );
      if (dejaFait) return alert("‚ö†Ô∏è D√©j√† rempli pour cette s√©ance.");

      const champs = [
        { name: "recuperation", label: "R√©cup√©ration" },
        { name: "sommeil", label: "Sommeil" },
        { name: "alimentation", label: "Alimentation / hydratation" },
        { name: "fatigue_physique", label: "Fatigue physique" },
        { name: "fatigue_mentale", label: "Fatigue mentale" }
      ];

      const valeurs = {};
      for (const c of champs) {
        const val = form[c.name].value;
        if (!val) return alert(`R√©ponds √† : ${c.label} (1 √† 5).`);
        valeurs[c.name] = Number(val);
      }

      const date = new Date().toLocaleString();
      const total = champs.reduce((s,c) => s + valeurs[c.name], 0);
      const pourcentage = Math.round((total / 25) * 100);

      let zoneTexte="", zoneClass="";
      if (pourcentage >= 88)      { zoneTexte="VERT FONC√â tr√®s bon √©tat"; zoneClass="zone-vert-fonce"; }
      else if (pourcentage >= 76) { zoneTexte="VERT CLAIR bon √©tat"; zoneClass="zone-vert-clair"; }
      else if (pourcentage >= 64) { zoneTexte="JAUNE fatigue l√©g√®re"; zoneClass="zone-jaune"; }
      else if (pourcentage >= 52) { zoneTexte="ORANGE fatigue notable"; zoneClass="zone-orange"; }
      else                        { zoneTexte="ROUGE fatigue importante"; zoneClass="zone-rouge"; }

      const record = {
        date,
        joueur,
        seance,
        recuperation: valeurs.recuperation,
        sommeil: valeurs.sommeil,
        alimentation: valeurs.alimentation,
        fatigue_physique: valeurs.fatigue_physique,
        fatigue_mentale: valeurs.fatigue_mentale,
        total,
        pourcentage,
        zone: zoneTexte,
        zoneClass,
        bonusStaff: document.getElementById("bonusStaff")?.value.trim() || "",
        douleurZone: document.getElementById("douleurZone").value.trim(),
        commentaire: document.getElementById("commentaire").value.trim(),
        envoye: false
      };

      enregistrements.push(record);
      sauvegarderDansStorage();

      if (navigator.onLine) envoyerVersGoogleSheets(record);

      const res = document.getElementById("resultat");
      res.textContent = `${joueur} | ${seance || "s√©ance non pr√©cis√©e"} | ${total}/25 (${pourcentage}%) - ${zoneTexte}`;
      res.className = "result " + zoneClass;

      majListeJoueurs();
      majStats();
      resetForm(false);
    }

    function majListeJoueurs() {
      const ul = document.getElementById("listeJoueursUl");
      if (!ul) return;
      ul.innerHTML = "";

      enregistrements.forEach((rec,i) => {
        const li = document.createElement("li");
        li.className = rec.zoneClass;
        li.textContent = `${i+1}. ${rec.joueur} - ${rec.pourcentage}% (${rec.zone}) ${rec.envoye ? "üü¢" : "üî¥"}`;
        ul.appendChild(li);
      });
    }

    function majStats() {
      const elNb = document.getElementById("statsNbJoueurs");
      const elMoy = document.getElementById("statsMoyenneScore");
      const elDom = document.getElementById("statsZoneDom");
      const indiceBox = document.getElementById("statsIndiceBox");
      const indiceLabel = document.getElementById("statsIndiceLabel");
      const recoEl = document.getElementById("statsRecoSeance");
      const alertesEl = document.getElementById("statsAlertesListe");

      const dernierParJoueur = {};
      enregistrements.forEach(r => dernierParJoueur[r.joueur] = r);
      const liste = Object.values(dernierParJoueur);
      const nb = liste.length;

      elNb.textContent = "Joueurs (derni√®re mesure) : " + nb;
      if (!nb) {
        elMoy.textContent = "Score moyen : -";
        elDom.textContent = "Zone dominante : -";
        indiceBox.className="stats-indice-box";
        indiceLabel.textContent="Indice bien-√™tre √©quipe : -";
        recoEl.textContent="Recommandation s√©ance : -";
        alertesEl.textContent="-";
        return;
      }

      let somme=0;
      const z={vf:0,vc:0,j:0,o:0,r:0};
      liste.forEach(rec=>{
        somme+=rec.total;
        if(rec.zoneClass==="zone-vert-fonce") z.vf++;
        else if(rec.zoneClass==="zone-vert-clair") z.vc++;
        else if(rec.zoneClass==="zone-jaune") z.j++;
        else if(rec.zoneClass==="zone-orange") z.o++;
        else z.r++;
      });

      const moy=(somme/nb).toFixed(1);
      elMoy.textContent="Score moyen : "+moy+" / 25";

      const zonesOrdre=[
        {code:"vf",nom:"VERT FONC√â"},
        {code:"vc",nom:"VERT CLAIR"},
        {code:"j",nom:"JAUNE"},
        {code:"o",nom:"ORANGE"},
        {code:"r",nom:"ROUGE"}
      ];
      let maxZone=""; let maxVal=-1;
      zonesOrdre.forEach(t=>{
        if(z[t.code]>maxVal){maxVal=z[t.code];maxZone=t.nom;}
      });
      elDom.textContent=`Zone dominante : ${maxZone} (${maxVal} joueurs)`;

      const pctEquipe=Math.round((parseFloat(moy)/25)*100);
      let classeIndice="",labelEquipe="";
      if(pctEquipe>=88){classeIndice="indice-vert";labelEquipe="Tr√®s bon √©tat";}
      else if(pctEquipe>=76){classeIndice="indice-vert";labelEquipe="Bon √©tat";}
      else if(pctEquipe>=64){classeIndice="indice-jaune";labelEquipe="Fatigue l√©g√®re";}
      else if(pctEquipe>=52){classeIndice="indice-orange";labelEquipe="Fatigue notable";}
      else {classeIndice="indice-rouge";labelEquipe="Fatigue importante";}
      indiceBox.className="stats-indice-box "+classeIndice;
      indiceLabel.textContent=`Indice bien-√™tre √©quipe : ${pctEquipe}% ‚Äì ${labelEquipe}`;

      const alertes=liste.filter(r=>r.zoneClass==="zone-orange"||r.zoneClass==="zone-rouge").map(r=>r.joueur);
      alertesEl.textContent=alertes.length?alertes.join(", "):"Aucun joueur en alerte.";

      const pctRO=Math.round(((z.o+z.r)/nb)*100);
      let reco="";
      if(pctEquipe>=80 && pctRO<=10) reco="√âquipe en forme : charge normale/haute possible.";
      else if(pctEquipe>=70 && pctRO<=25) reco="Fatigue mod√©r√©e : charge normale, surveiller alertes.";
      else if(pctEquipe>=60 || pctRO>30) reco="Plusieurs fatigu√©s : r√©duire volume/intensit√©, individualiser.";
      else reco="Fatigue √©lev√©e : s√©ance r√©cup√©ration/all√©g√©e.";
      recoEl.textContent="Recommandation s√©ance : "+reco;
    }

    function resetForm(clearResult) {
      const form = document.getElementById("fatigueForm");
      form.reset();
      rowAutre.style.display="none";
      inputAutre.value="";
      document.querySelectorAll(".scale button").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll('input[type="hidden"]').forEach(i=>i.value="");

      if(clearResult){
        const res=document.getElementById("resultat");
        res.textContent="";
        res.className="result";
      }
    }

    function sauvegarderDansStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(enregistrements));
    }

    function chargerDepuisStorage() {
      try{
        const parsed=JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        enregistrements=Array.isArray(parsed)?parsed:[];
      }catch{
        enregistrements=[];
      }
      majListeJoueurs();
      majStats();
    }

    function resetDonnees() {
      if(!confirm("Supprimer toutes les r√©ponses locales ?")) return;
      enregistrements=[];
      localStorage.removeItem(STORAGE_KEY);
      majListeJoueurs();
      majStats();
      resetForm(true);
    }

    chargerDepuisStorage();
    initDateSeance();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker enregistr√©"))
        .catch(err => console.log("Erreur SW:", err));
    }
  </script>

  <!-- GRAPHIQUES COACH -->
  <section id="stats-equipe" class="card coach-only" style="margin-top:20px;">
    <h2>Statistiques √©quipe (Google Sheets)</h2>

    <div class="stats-grid">
      <div class="stats-chart-card">
        <h3>Top 5 joueurs les plus fatigu√©s</h3>
        <div class="iframe-container">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSZOoAxXWypXm2R1xpiBnnW7CZ_qYsAuB3_OIZbcrspuwPy8iYjWmOlouo5gPhskbbRB5RZVFC2WBL5/pubchart?oid=1899617904&format=interactive"
            loading="lazy"
            allowfullscreen>
          </iframe>
        </div>
      </div>

      <div class="stats-chart-card">
        <h3>Top 5 joueurs les plus en forme</h3>
        <div class="iframe-container">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSZOoAxXWypXm2R1xpiBnnW7CZ_qYsAuB3_OIZbcrspuwPy8iYjWmOlouo5gPhskbbRB5RZVFC2WBL5/pubchart?oid=2032210019&format=interactive"
            loading="lazy"
            allowfullscreen>
          </iframe>
        </div>
      </div>
    </div>
  </section>

</body>
</html>
